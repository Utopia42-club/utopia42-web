<div class="root" fxLayout="row" fxLayoutAlign="center start" fxLayoutGap="6px">
    <button [disabled]="isPrevDisabled()" class="prevNavigationButton" mat-raised-button color="primary"
            (click)="prevClicked()">Previous
    </button>
    <div fxFlex>
        <mat-stepper [linear]="true" #stepper>
            <mat-step completed="false" label="Select plugin">
                <form [formGroup]="form" class="form">
                    <mat-form-field class="form__field">
                        <mat-label>Plugin script url</mat-label>
                        <input matInput formControlName="scriptUrl" type="text"/>
                    </mat-form-field>
                    <mat-form-field class="form__field">
                        <mat-label>Plugin inputs url</mat-label>
                        <input matInput formControlName="inputsUrl" type="text"/>
                    </mat-form-field>
                </form>
            </mat-step>
            <mat-step completed="false" label="Fill out plugin inputs">
                <ng-template matStepContent>
                    <form *ngIf="inputsForm != null" [formGroup]="inputsForm" class="inputs">
                        <div *ngFor="let input of inputs" [ngSwitch]="input.type">
                            <ng-container *ngSwitchCase="'number'">
                                <ng-container
                                    *ngTemplateOutlet="numberField; context: {input: input}">
                                </ng-container>
                            </ng-container>
                            <ng-container *ngSwitchCase="'text'">
                                <ng-container
                                    *ngTemplateOutlet="textField; context: {input: input}">
                                </ng-container>
                            </ng-container>
                            <ng-container *ngSwitchCase="'selection'">
                                <ng-container
                                    *ngTemplateOutlet="selectionField; context: {input: input}">
                                </ng-container>
                            </ng-container>
                        </div>
                    </form>
                    <div *ngIf="inputsForm == null" class="loading-inputs">
                        <p>Loading plugin inputs...</p>
                    </div>
                </ng-template>
            </mat-step>
        </mat-stepper>
    </div>
    <button [disabled]="isNextDisabled()" class="nextNavigationButton" mat-raised-button color="primary"
            (click)="nextClicked()">
        {{stepper.selectedIndex == 1 ? 'Run' : 'Next'}}
    </button>
</div>

<ng-template #numberField let-input="input">
    <form [formGroup]="inputsForm">
        <mat-form-field *ngIf="input.options == null">
            <mat-label>{{input.label ?? input.name}}</mat-label>
            <input matInput [required]="input.required" [formControlName]="input.name" type="number"/>
            <mat-hint *ngIf="input.hint != null">{{input.hint}}</mat-hint>
        </mat-form-field>
        <mat-form-field *ngIf="input.options != null">
            <mat-label>{{input.label ?? input.name}}</mat-label>
            <input matInput [required]="input.required" [formControlName]="input.name" type="number"
                   [matAutocomplete]="auto"/>
            <mat-hint *ngIf="input.hint != null">{{input.hint}}</mat-hint>
            <mat-autocomplete #auto="matAutocomplete">
                <mat-option *ngFor="let option of input.options | filterInputOptions : inputsForm!.value[input.name]"
                            [value]="option.value">
                    <span>{{option.key}}</span>
                </mat-option>
            </mat-autocomplete>
        </mat-form-field>
    </form>
</ng-template>

<ng-template #textField let-input="input">
    <form [formGroup]="inputsForm">
        <mat-form-field *ngIf="input.options == null">
            <mat-label>{{input.label ?? input.name}}</mat-label>
            <input matInput [required]="input.required" [formControlName]="input.name" type="text"/>
            <mat-hint *ngIf="input.hint != null">{{input.hint}}</mat-hint>
        </mat-form-field>
        <mat-form-field *ngIf="input.options != null">
            <mat-label>{{input.label ?? input.name}}</mat-label>
            <input matInput [required]="input.required" [formControlName]="input.name" type="text"
                   [matAutocomplete]="auto"/>
            <mat-hint *ngIf="input.hint != null">{{input.hint}}</mat-hint>
            <mat-autocomplete #auto="matAutocomplete">
                <mat-option *ngFor="let option of input.options | filterInputOptions : inputsForm!.value[input.name]"
                            [value]="option.value">
                    <span>{{option.key}}</span>
                </mat-option>
            </mat-autocomplete>
        </mat-form-field>
    </form>
</ng-template>

<ng-template #selectionField let-input="input">
    <form [formGroup]="inputsForm">
        <mat-form-field>
            <mat-label>{{input.label ?? input.name}}</mat-label>
            <mat-select [required]="input.required" [formControlName]="input.name">
                <mat-option *ngFor="let option of input.options" [value]="option.value">
                    {{option.key}}
                </mat-option>
            </mat-select>
            <mat-hint *ngIf="input.hint != null">{{input.hint}}</mat-hint>
        </mat-form-field>
    </form>
</ng-template>
