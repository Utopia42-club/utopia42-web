<div class="root" fxLayout="column" fxLayoutAlign="space-between center">
    <div *ngIf="inputsForm != null" fxLayout="column" style="width: 100%">
        <p class="title">{{plugin.name}} plugin</p>
        <p class="subtitle" *ngIf="inputs != null && inputs.length > 0">Please fill out input parameters</p>
        <form [formGroup]="inputsForm" class="inputs"
              [gdAreas]="gridAreas" [gdColumns]="templateColumns" [gdRows]="templateRows"
              gdGap="0.5em">
            <div *ngFor="let input of inputs" [ngClass]="{'list-field' : input.isList}"
                 [gdArea]="input.name">
                <ng-container *ngIf="!input.isList">
                    <ng-container
                        *ngTemplateOutlet="inputField; context: {input: input, formControl:inputsForm.get(input.name)}">
                    </ng-container>
                </ng-container>
                <ng-container *ngIf="input.isList">
                    <div fxLayout="column" fxLayoutAlign="space-between center" style="width: 100%;height: 100%">
                        <div fxLayout="column" style="width: 100%;height: 100%; overflow-y: auto">
                            <p [innerHtml]="((input.label ?? input.name) + (input.required ? '*' :'')) | sanitize"
                               class="list-field__label">
                            </p>
                            <div
                                *ngFor="let formControl of asFormArray(inputsForm.get(input.name)).controls; let i = index">
                                <div fxLayout="row" fxLayoutAlign="start center" fxLayoutGap="0.4em">
                                    <ng-container fxFlex
                                                  *ngTemplateOutlet="inputField; context: {input: input, formControl:formControl}">
                                    </ng-container>
                                    <button mat-icon-button color="warn" class="delete-link-button"
                                            (click)="removeListItem(input, formControl)">
                                        <mat-icon>delete</mat-icon>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div style="width: 100%" fxLayout="row" fxLayoutAlign="end center">
                            <button mat-stroked-button style="width: 100%" (click)="addListItem(input)">
                                <mat-icon>add</mat-icon>
                            </button>
                        </div>
                    </div>
                </ng-container>
            </div>
        </form>
    </div>
    <div *ngIf="inputsForm == null" fxLayout="row" fxLayoutAlign="center center" class="loading-inputs">
        <p>Loading plugin inputs...</p>
    </div>
    <div fxLayout="row" fxLayoutAlign="end center" fxLayoutGap="0.5em" class="actions">
        <button *ngIf="inputsForm != null" mat-raised-button color="primary"
                (click)="submit()" [disabled]="!this.inputsForm.valid">
            Submit
        </button>
        <button mat-raised-button color="accent"
                (click)="cancel()">
            Cancel
        </button>
    </div>
</div>

<ng-template #inputField let-input="input" let-formControl="formControl">
    <ng-container [ngSwitch]="input.type">
        <ng-container *ngSwitchCase="'number'">
            <ng-container
                *ngTemplateOutlet="numberField; context: {input: input, formControl:formControl}">
            </ng-container>
        </ng-container>
        <ng-container *ngSwitchCase="'text'">
            <ng-container
                *ngTemplateOutlet="textField; context: {input: input, formControl:formControl}">
            </ng-container>
        </ng-container>
        <ng-container *ngSwitchCase="'selection'">
            <ng-container
                *ngTemplateOutlet="selectionField; context: {input: input, formControl:formControl}">
            </ng-container>
        </ng-container>
        <ng-container *ngSwitchCase="'position'">
            <ng-container
                *ngTemplateOutlet="positionField; context: {input: input, formControl:formControl}">
            </ng-container>
        </ng-container>
        <ng-container *ngSwitchCase="'land'">
            <ng-container
                *ngTemplateOutlet="landField; context: {input: input, formControl:formControl}">
            </ng-container>
        </ng-container>
        <ng-container *ngSwitchCase="'blockType'">
            <ng-container
                *ngTemplateOutlet="blockTypeField; context: {input: input, formControl:formControl}">
            </ng-container>
        </ng-container>
    </ng-container>
</ng-template>


<ng-template #numberField let-input="input" let-formControl="formControl">
    <mat-form-field *ngIf="input.options == null" class="input-field">
        <mat-label *ngIf="!input.isList" [innerHtml]="(input.label ?? input.name) | sanitize"></mat-label>
        <input matInput [required]="input.required" [formControl]="formControl" type="number"/>
        <mat-hint *ngIf="input.hint != null" [innerHtml]="input.hint | sanitize"></mat-hint>
    </mat-form-field>
    <mat-form-field *ngIf="input.options != null" class="input-field">
        <mat-label *ngIf="!input.isList" [innerHtml]="(input.label ?? input.name) | sanitize"></mat-label>
        <input matInput [required]="input.required" [formControl]="formControl" type="number"
               [matAutocomplete]="auto"/>
        <mat-hint *ngIf="input.hint != null" [innerHtml]="input.hint | sanitize"></mat-hint>
        <mat-autocomplete #auto="matAutocomplete">
            <mat-option *ngFor="let option of input.options | filterInputOptions : inputsForm!.value[input.name]"
                        [value]="option.value">
                <span>{{option.key}}</span>
            </mat-option>
        </mat-autocomplete>
    </mat-form-field>
</ng-template>

<ng-template #textField let-input="input" let-formControl="formControl">
    <mat-form-field *ngIf="input.options == null" class="input-field">
        <mat-label *ngIf="!input.isList" [innerHtml]="(input.label ?? input.name) | sanitize"></mat-label>
        <input matInput [required]="input.required" [formControl]="formControl" type="text"/>
        <mat-hint *ngIf="input.hint != null" [innerHtml]="input.hint | sanitize"></mat-hint>
    </mat-form-field>
    <mat-form-field *ngIf="input.options != null" class="input-field">
        <mat-label *ngIf="!input.isList" [innerHtml]="(input.label ?? input.name) | sanitize"></mat-label>
        <input matInput [required]="input.required" [formControl]="formControl" type="text"
               [matAutocomplete]="auto"/>
        <mat-hint *ngIf="input.hint != null" [innerHtml]="input.hint | sanitize"></mat-hint>
        <mat-autocomplete #auto="matAutocomplete">
            <mat-option *ngFor="let option of input.options | filterInputOptions : inputsForm!.value[input.name]"
                        [value]="option.value">
                <span>{{option.key}}</span>
            </mat-option>
        </mat-autocomplete>
    </mat-form-field>

</ng-template>

<ng-template #selectionField let-input="input" let-formControl="formControl">
    <mat-form-field class="input-field">
        <mat-label *ngIf="!input.isList" [innerHtml]="(input.label ?? input.name) | sanitize"></mat-label>
        <mat-select [required]="input.required" [formControl]="formControl">
            <mat-option *ngFor="let option of input.options ?? []" [value]="option.value">
                {{option.key}}
            </mat-option>
        </mat-select>
        <mat-hint *ngIf="input.hint != null" [innerHtml]="input.hint | sanitize"></mat-hint>
    </mat-form-field>
</ng-template>

<ng-template #positionField let-input="input" let-formControl="formControl">
    <form [formGroup]="inputsForm" fxLayout="row" style="width: 100%">
        <app-position-field [required]="input.required" [formControl]="formControl"
                            [label]="input.label ?? input.name" [hint]="input.hint" [isList]="input.isList"
                            [positionOptions]="positionOptions | async" style="width: 100%">
        </app-position-field>
    </form>
</ng-template>

<ng-template #landField let-input="input" let-formControl="formControl">
    <mat-form-field class="input-field">
        <mat-label *ngIf="!input.isList" [innerHtml]="(input.label ?? input.name) | sanitize"></mat-label>
        <mat-select [required]="input.required" [formControl]="formControl">
            <mat-option *ngFor="let option of landOptions | async;let ind=index" [value]="option">
                    <span *ngIf="option.properties != null && option.properties.name != null; else elseLand">
                        {{option.properties.name}} #{{option.id}}
                    </span>
                <ng-template #elseLand>
                    <span>Land #{{option.id}}</span>
                </ng-template>
            </mat-option>
        </mat-select>
        <mat-hint *ngIf="input.hint != null" [innerHtml]="input.hint | sanitize"></mat-hint>
    </mat-form-field>
</ng-template>


<ng-template #blockTypeField let-input="input" let-formControl="formControl">
    <app-block-type-field [required]="input.required" [formControl]="formControl"
                          [label]="input.label ?? input.name" [hint]="input.hint" [isList]="input.isList"
                          [blockTypes]="blockTypes | async" style="width: 100%">
    </app-block-type-field>
</ng-template>
