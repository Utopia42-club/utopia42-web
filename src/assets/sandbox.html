<!DOCTYPE html>
<html>
<head>
    <script>
        worker = undefined;

        window.addEventListener('message', function (e) {
            let mainWindow = e.source;
            let target = e.origin;
            let message = e.data;
            if (message.type === 'request') {
                let code = `
                    UtopiaApi = {
                        placeBlock: function (type, x, y, z) {
                            postMessage({
                                    type: 'request',
                                    body: {
                                        method: 'placeBlock',
                                        params: [type, x, y, z]
                                    }
                                }
                            )
                        },
                    };

                    onmessage = function (e) {
                        var Inputs = e.data.inputs;
                        try {
                            ${message.body.code}
                            main().then(() => {
                                postMessage({
                                    type: 'end'
                                });
                            });
                        } catch (e) {
                            postMessage({
                                type: 'error',
                                body: e.message
                            });
                        }
                    }
                `;
                let bb = new Blob([code],
                    {
                        type: 'text/javascript'
                    });

                let bbURL = URL.createObjectURL(bb);
                this.worker = new Worker(bbURL);
                this.worker.onmessage = function (e) {
                    mainWindow.postMessage(e.data, target);
                }
                this.worker.postMessage(message.body);
            } else if (message.type === 'end') {
                this.worker.terminate();
                this.worker = undefined;
            } else {
                throw new Error('Unknown message type sent to sandbox: ' + message.type);
            }
        });
    </script>
</head>
<body>
</body>
</html>
